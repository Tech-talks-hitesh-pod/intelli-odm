# Demand Forecasting Agent - Output Structure

This document describes the complete output structure generated by the Demand Forecasting Agent, keeping all capabilities intact.

## Main Output Structure

The agent's `run()` method returns a tuple: `(final_results, sensitivity_analysis)`

### 1. Final Results (`final_results`)

```python
{
    # Task 1: Model Selection Results
    'model_selection': {
        'selected_model': 'hybrid' | 'time_series' | 'decay_model' | 'analogy_based' | 'fallback_lr_kmeans',
        'model_params': {
            'model_type': 'hybrid',
            'components': ['time_series', 'decay', 'analogy'],
            # ... other model-specific parameters
        },
        'model_scores': {
            'time_series': {'score': 0.85, 'params': {...}},
            'decay_model': {'score': 0.72, 'params': {...}},
            'analogy_based': {'score': 0.68, 'params': {...}},
            'hybrid': {'score': 0.88, 'params': {...}}
        },
        'llm_recommendation': {
            'recommended_model': 'hybrid',
            'reasoning': 'Based on data characteristics',
            'llm_response': '...'
        },
        'data_characteristics': {
            'has_time_series': True,
            'time_series_length': 90,
            'has_comparables': True,
            'num_comparables': 5,
            'decay_pattern': 'moderate_decay',
            'seasonality_detected': False,
            'store_count': 25,
            'sku_count': 150
        },
        'fallback_used': False
    },
    
    # Task 2: Factor Analysis Results
    'factor_analysis': {
        'correlation_matrix': {
            # Correlation matrix between all numeric features and units_sold
            'price': 0.45,
            'price_bucket_encoded': 0.38,
            'day_of_week': 0.12,
            # ... other correlations
        },
        'top_correlations': {
            'price': 0.45,
            'price_bucket_encoded': 0.38,
            'store_avg_sales': 0.32,
            # ... top 10 correlations
        },
        'strong_correlations': {
            # Correlations > 0.5
        },
        'pca_results': {
            'n_components': 5,
            'explained_variance_ratio': [0.35, 0.22, 0.18, 0.12, 0.08],
            'cumulative_variance': [0.35, 0.57, 0.75, 0.87, 0.95],
            'components': [[...], [...], ...],  # PCA transformed data
            'feature_loadings': {
                'price': [...],
                'units_sold': [...],
                # ... feature loadings for each component
            }
        },
        'price_analysis': {
            'bucket_statistics': [
                {
                    'price_bucket': '200-300',
                    'total_units': 1500,
                    'avg_units': 12.5,
                    'transaction_count': 120,
                    'total_revenue': 450000
                },
                # ... for each price bucket
            ],
            'price_elasticity': {
                '200-300': {
                    'avg_price': 250,
                    'avg_units': 12.5,
                    'price_per_unit': 20.0
                },
                # ... for each price bucket
            }
        },
        'factor_importance': [
            ('price', 0.25),
            ('store_avg_sales', 0.18),
            ('price_bucket_encoded', 0.15),
            ('day_of_week', 0.12),
            # ... sorted by importance (Random Forest)
        ],
        'sensitivity_results': {
            'price_sensitivity': {
                'price_250': {
                    'below_threshold_avg_sales': 15.2,
                    'above_threshold_avg_sales': 10.8,
                    'sensitivity_ratio': 1.41
                },
                # ... for different price thresholds
            },
            'attr_material_sensitivity': {
                # Sensitivity by material attribute
            },
            # ... other attribute sensitivities
        }
    },
    
    # Task 3: Forecast Results
    'forecast_results': {
        'store_level_forecasts': {
            'store_001': {
                'TS-114': {
                    'store_id': 'store_001',
                    'article': 'TS-114',
                    'forecast_quantity': 220,
                    'confidence_low': 165,
                    'confidence_high': 275,
                    'recommendation': 'buy' | 'buy_cautious' | 'skip' | 'skip_margin_risk',
                    'reasoning': 'Prophet time series forecast | Optimized: ROS=3.67/day, ST=75.2%, Margin=40.0%',
                    'price': 349,
                    'method_used': 'time_series' | 'decay_model' | 'analogy_based' | 'hybrid' | 'fallback_lr_kmeans',
                    'optimized_quantity': 220,
                    'original_quantity': 200,
                    'expected_sell_through_rate': 0.752,
                    'expected_rate_of_sale': 3.67,  # units per day
                    'expected_units_sold': 165,
                    'margin_pct': 0.40,
                    'margin_protected': True,
                    'current_inventory': 45,
                    'optimization_score': 0.82  # 0-1 scale
                },
                'TS-203': {
                    # ... similar structure for each article
                }
            },
            'store_002': {
                # ... forecasts for each store
            }
        },
        'aggregated_forecast': {
            'total_quantity': 12400,
            'unique_articles': ['TS-114', 'TS-203', 'TS-301'],
            'num_articles': 3,
            'stores_with_recommendations': 25,
            'total_stores': 25,
            'total_expected_units_sold': 9300,
            'avg_sell_through_rate': 0.75,
            'avg_margin_pct': 0.40,
            'total_revenue': 3245700,
            'total_margin_value': 1298280,
            'avg_optimization_score': 0.78
        },
        'recommendations': {
            'articles_to_buy': ['TS-114', 'TS-203', 'TS-301'],  # Sorted by optimization score
            'store_allocations': {
                'TS-114': {
                    'store_001': {
                        'quantity': 220,
                        'expected_sell_through': 0.752,
                        'expected_rate_of_sale': 3.67,
                        'margin_pct': 0.40,
                        'optimization_score': 0.82,
                        'recommendation': 'buy'
                    },
                    'store_002': {
                        # ... allocation details for each store
                    }
                },
                'TS-203': {
                    # ... allocations for each article
                }
            },
            'total_procurement_quantity': 12400,
            'priority_stores': [
                ('store_001', 0.85, 220),  # (store_id, avg_score, total_qty)
                ('store_005', 0.82, 190),
                # ... top 10 stores by optimization score
            ],
            'expected_metrics': {
                'total_expected_units_sold': 9300,
                'avg_sell_through_rate': 0.75,
                'avg_margin_pct': 0.40,
                'total_revenue': 3245700,
                'total_margin_value': 1298280,
                'avg_optimization_score': 0.78
            },
            'risk_assessment': {
                'margin_risk_articles': ['TS-501'],  # Articles with margin < min_margin_pct
                'low_sell_through_articles': ['TS-402'],  # Articles with ST < 70% of target
                'high_confidence_articles': ['TS-114', 'TS-203', 'TS-301']  # Articles with good metrics
            },
            'optimization_summary': '''
                Optimized recommendation: Procure 3 articles with total quantity of 12400 units across 25 stores.
                Expected performance:
                  - Sell-through rate: 75.0% (target: 75.0%)
                  - Average margin: 40.0% (min: 25.0%)
                  - Expected revenue: ₹3,245,700
                  - Expected margin value: ₹1,298,280
                  - Optimization score: 0.78/1.0
                ⚠️  Margin risk detected for 1 articles. Consider price adjustments or skip procurement.
            ''',
            'total_stores': 25,
            'universe_of_stores': 30,
            'store_universe_validation': {
                'valid': True,
                'message': 'Total stores (25) is within universe (30).',
                'total_stores': 25,
                'universe_of_stores': 30
            },
            'article_level_metrics': {
                'TS-114': {
                    'article': 'TS-114',
                    'article_details': {
                        'style_code': 'TSH-001',
                        'color': 'White',
                        'segment': 'Casual',
                        'family': 'T-Shirts',
                        'class': 'Basic',
                        'brick': 'Men\'s Apparel'
                    },
                    'total_store_exposure': 15,
                    'mrp': 499.0,
                    'average_selling_price': 349.0,
                    'average_discount': 30.1,
                    'margin_pct': 0.40,
                    'ros': 3.67,  # Rate of Sale (units per day)
                    'str': 0.752,  # Sell-Through Rate
                    'net_sales_value': 576300.0,
                    'total_quantity': 2200,
                    'expected_units_sold': 1654
                },
                'TS-203': {
                    # ... similar structure for each article
                }
            }
        },
        'forecast_horizon_days': 60,
        'model_used': 'hybrid',
        'optimization_metrics': {
            'target_sell_through_pct': 0.75,
            'min_margin_pct': 0.25,
            'default_margin_pct': 0.40
        }
    },
    
    # Validation and System Information
    'validation_messages': [
        'WARNING: Sales data missing date column. Time-series forecasting will be limited.',
        'INFO: No comparable products found. Analogy-based forecasting will be unavailable.'
    ],
    'fallback_used': False  # True if fallback method (LR+KMeans) was used
}
```

### 2. Sensitivity Analysis (`sensitivity_analysis`)

```python
{
    'price_sensitivity': {
        'price_250': {
            'below_threshold_avg_sales': 15.2,
            'above_threshold_avg_sales': 10.8,
            'sensitivity_ratio': 1.41
        },
        'price_350': {
            # ... for different price thresholds
        }
    },
    'attr_material_sensitivity': {
        'Cotton': 12.5,
        'Polyester': 10.2,
        # ... average units sold by material
    },
    'attr_color_sensitivity': {
        # ... sensitivity by color attribute
    }
    # ... other attribute sensitivities
}
```

## Error Output Structure

If validation fails or forecasting encounters critical errors:

```python
{
    'error': True,
    'error_type': 'data_validation_failed' | 'forecasting_failed',
    'message': 'CRITICAL: Input data validation failed. Please fix the data inconsistencies before proceeding.',
    'validation_messages': [
        'CRITICAL: Sales data missing required columns: store_id, sku',
        'WARNING: Inventory data is missing. Forecast accuracy may be reduced.'
    ],
    'forecast_results': {},
    'recommendations': {}
}
```

## Key Output Features

### 1. **Store-Level Forecasts**
- Individual forecasts for each store-article combination
- Includes quantity, confidence intervals, recommendations
- Optimization metrics (rate of sale, sell-through, margin)
- Method used (time_series, decay, analogy, hybrid, or fallback)

### 2. **Optimized Recommendations**
- Articles sorted by optimization score
- Store-level allocations with detailed metrics
- Priority stores ranked by performance
- Risk assessment (margin risk, low sell-through risk)

### 3. **Expected Performance Metrics**
- Total expected units sold
- Average sell-through rate
- Average margin percentage
- Total revenue and margin value
- Overall optimization score

### 4. **Factor Analysis**
- Correlation analysis of product attributes
- PCA for dimensionality reduction
- Price bucket analysis with elasticity
- Factor importance ranking
- Sensitivity analysis

### 5. **Model Selection Information**
- Selected forecasting model
- Model scores and parameters
- LLM recommendations (if used)
- Data characteristics analysis
- Fallback method indicator

## Output Format

The output is returned as a Python dictionary/tuple structure that can be:
- Serialized to JSON for API responses
- Used directly in Python for further processing
- Converted to reports or visualizations
- Stored in databases for historical tracking

## Example Usage

```python
from agents.demand_forecasting_agent import DemandForecastingAgent

agent = DemandForecastingAgent(llama_client=llama_client)

# Run forecasting
final_results, sensitivity_analysis = agent.run(
    comparables=comparables,
    sales_data=sales_df,
    inventory_data=inventory_df,
    price_data=price_df,
    price_options=[299, 349, 399],
    product_attributes={'material': 'Cotton', 'color': 'White'},
    forecast_horizon_days=60
)

# Access results
recommendations = final_results['recommendations']
forecasts = final_results['forecast_results']['store_level_forecasts']
optimization_summary = recommendations['optimization_summary']

print(optimization_summary)
# Output: Optimized recommendation: Procure 3 articles with total quantity of 12400 units...
```

## Notes

- All numeric values are floats (quantities, percentages, scores)
- Percentages are represented as decimals (0.75 = 75%)
- Recommendations can be: 'buy', 'buy_cautious', 'skip', 'skip_margin_risk'
- Optimization scores range from 0.0 to 1.0
- All capabilities remain intact with enhanced error handling and fallback mechanisms

